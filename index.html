<!DOCTYPE html>
<html lang="en">

<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>Document</title>
</head>
<style>
   body {
      cursor: pointer;
   }
</style>

<body>
   <!-- 
   <script
      src="https://www.paypal.com/sdk/js?client-id=AV1uL-M4qBVKPCj2M5pO5mksUY5iqA6gW0vXhBuqYQWnfHnH_qSB4juSA68Nop_s71oXgn49znwPzLrc&vault=true"></script> -->

   <script
      src="https://www.paypal.com/sdk/js?client-id=AV1uL-M4qBVKPCj2M5pO5mksUY5iqA6gW0vXhBuqYQWnfHnH_qSB4juSA68Nop_s71oXgn49znwPzLrc&vault=true&intent=subscription"></script>

   <!-- <script>
      paypal.Buttons({
         createSubscription: function (data, actions) {
            // Llama a tu API para crear un plan
            return fetch('/api/create-plan', {
               method: 'POST',
               headers: {
                  'Content-Type': 'application/json'
               },
               body: JSON.stringify({
                  product_id: 'YOUR_PRODUCT_ID',
                  name: 'Nombre del plan',
                  billing_cycles: [
                     {
                        frequency: {
                           interval_unit: 'MONTH',
                           interval_count: '1'
                        },
                        tenure_type: 'REGULAR',
                        sequence: '1',
                        total_billing_cycles: '12',
                        pricing_scheme: {
                           fixed_price: {
                              currency_code: 'USD',
                              value: '10.00'
                           }
                        }
                     }
                  ]
               })
            }).then(function (response) {
               if (!response.ok) {
                  throw new Error('Error al crear el plan');
               }
               return response.json();
            }).then(function (data) {
               // Retorna el ID del plan creado
               return data.id; // Asegúrate de que esta respuesta incluya el ID
            });
         },
         onApprove: function (data, actions) {
            // Llama a tu API para crear una suscripción
            return fetch('/api/create-subscription', {
               method: 'POST',
               headers: {
                  'Content-Type': 'application/json'
               },
               body: JSON.stringify({
                  plan_id: data.id, // Usa el ID del plan creado
                  quantity: '1', // Especifica la cantidad
               })
            }).then(function (response) {
               return response.json();
            }).then(function (data) {
               if (data.status === "ACTIVE") {
                  alert('¡Suscripción activa!');
               } else {
                  alert('Suscripción pendiente de aprobación.');
               }
            });
         }
      }).render('#paypal-button-container'); // Renderiza el botón en el contenedor
   </script> -->
   <div id="paypal-button-container"></div>
   <script>
      window.paypal.Buttons({
         style: {
            shape: "rect",
            layout: "vertical",
            color: "gold",
            label: "paypal",
         },
         createSubscription: async function (data, actions) {
            const response = await fetch("http://localhost:3002/api/v1/subscription/create/plan", {
               method: "POST",
               headers: {
                  "Content-Type": "application/json",
               },
               body: JSON.stringify({
                  "membership_id": "c4a1dd1a-f5e2-419c-a16c-4dbc5788186c",
               }),
            });

            const dataJson = await response.json();
            console.log("Plan ID recibido de la API:", dataJson.planId);

            if (response.status !== 201) {
               throw new Error("No se recibió un plan ID válido de la API");
            }

            return actions.subscription.create({
               plan_id: 'P-00T80607L5857831NM4ZWQFA'
            });
         },

         onApprove: function (data, actions) {

            fetch(`http://localhost:3002/api/v1/subscription/create/subscription/${data.subscriptionID}`, {
               method: "GET",
            })
               .then(response => response.json())
               .then(data => {
                  alert("Suscripción completada con éxito");
               })
               .catch((error) => {
                  console.error("Error al guardar la suscripción:", error);
               });
         },
         onError: function (err) {
            console.error("Error en el proceso de suscripción:", err);
         }
      }).render("#paypal-button-container");
   </script>


</body>

</html>